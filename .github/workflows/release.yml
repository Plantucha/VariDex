name: Release & Publish

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v6.4.0)'
        required: true
      pypi_env:
        description: 'PyPI environment (test or production)'
        required: true
        default: 'test'
        type: choice
        options:
          - test
          - production

permissions:
  contents: write
  id-token: write

jobs:
  # ==================== PRE-RELEASE VALIDATION ====================
  validate:
    name: Pre-Release Validation
    runs-on: ubuntu-latest
    
    outputs:
      version: ${{ steps.version.outputs.version }}
      is_prerelease: ${{ steps.version.outputs.is_prerelease }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Extract version
      id: version
      run: |
        if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
          VERSION="${{ github.event.inputs.version }}"
        else
          VERSION="${GITHUB_REF#refs/tags/}"
        fi
        echo "version=${VERSION}" >> $GITHUB_OUTPUT
        
        # Check if pre-release (alpha, beta, rc)
        if [[ "$VERSION" =~ (alpha|beta|rc) ]]; then
          echo "is_prerelease=true" >> $GITHUB_OUTPUT
        else
          echo "is_prerelease=false" >> $GITHUB_OUTPUT
        fi
        
        echo "ğŸ·ï¸ Release Version: $VERSION"
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .
    
    - name: Verify version consistency
      run: |
        PACKAGE_VERSION=$(python -c "import varidex; print(varidex.__version__)")
        TAG_VERSION="${{ steps.version.outputs.version }}"
        TAG_VERSION="${TAG_VERSION#v}"
        
        if [ "$PACKAGE_VERSION" != "$TAG_VERSION" ]; then
          echo "âŒ Version mismatch!"
          echo "Package version: $PACKAGE_VERSION"
          echo "Tag version: $TAG_VERSION"
          exit 1
        fi
        
        echo "âœ… Version consistency check passed: $PACKAGE_VERSION"
    
    - name: Run quick tests
      run: |
        pip install pytest
        pytest tests/ -v --maxfail=3 || echo "âš ï¸ Some tests failed, but continuing..."

  # ==================== BUILD PACKAGE ====================
  build:
    name: Build Distribution Packages
    runs-on: ubuntu-latest
    needs: validate
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install build tools
      run: |
        python -m pip install --upgrade pip build twine
    
    - name: Build source and wheel distributions
      run: |
        echo "ğŸ“¦ Building package..."
        python -m build
        ls -lh dist/
    
    - name: Verify distributions
      run: |
        echo "âœ… Checking package integrity..."
        twine check dist/*
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: dist-packages
        path: dist/
        retention-days: 30

  # ==================== PUBLISH TO TEST PYPI ====================
  publish-test:
    name: Publish to Test PyPI
    runs-on: ubuntu-latest
    needs: build
    if: |
      github.event_name == 'workflow_dispatch' && 
      github.event.inputs.pypi_env == 'test'
    environment:
      name: test-pypi
      url: https://test.pypi.org/p/varidex
    
    steps:
    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: dist-packages
        path: dist/
    
    - name: Publish to Test PyPI
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        repository-url: https://test.pypi.org/legacy/
        skip-existing: true

  # ==================== PUBLISH TO PRODUCTION PYPI ====================
  publish-prod:
    name: Publish to PyPI
    runs-on: ubuntu-latest
    needs: build
    if: |
      (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')) ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.pypi_env == 'production')
    environment:
      name: pypi
      url: https://pypi.org/p/varidex
    
    steps:
    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: dist-packages
        path: dist/
    
    - name: Publish to PyPI
      uses: pypa/gh-action-pypi-publish@release/v1

  # ==================== CREATE GITHUB RELEASE ====================
  github-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [validate, build]
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Generate changelog
      id: changelog
      run: |
        VERSION="${{ needs.validate.outputs.version }}"
        
        # Extract changelog section for this version
        if [ -f CHANGELOG.md ]; then
          awk "/^## \[$VERSION\]/,/^## \[/{if(/^## \[/&&NR!=1)exit;print}" CHANGELOG.md > release_notes.md
        else
          echo "Release $VERSION" > release_notes.md
        fi
        
        # Add commit history if changelog is empty
        if [ ! -s release_notes.md ]; then
          echo "## Changes" > release_notes.md
          git log --pretty=format:"- %s" $(git describe --tags --abbrev=0 HEAD^)..HEAD >> release_notes.md
        fi
    
    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: dist-packages
        path: dist/
    
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        body_path: release_notes.md
        files: dist/*
        draft: false
        prerelease: ${{ needs.validate.outputs.is_prerelease }}
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ==================== POST-RELEASE NOTIFICATION ====================
  notify:
    name: Post-Release Notification
    runs-on: ubuntu-latest
    needs: [publish-prod, github-release]
    if: always() && (needs.publish-prod.result == 'success' || needs.github-release.result == 'success')
    
    steps:
    - name: Release summary
      run: |
        echo "ğŸ‰ ===================================="
        echo "ğŸ‰ RELEASE SUCCESSFUL!"
        echo "ğŸ‰ ===================================="
        echo "ğŸ“Œ Version: ${{ needs.validate.outputs.version }}"
        echo "ğŸ“¦ PyPI: ${{ needs.publish-prod.result }}"
        echo "ğŸ·ï¸ GitHub Release: ${{ needs.github-release.result }}"
        echo "ğŸ‰ ===================================="
        echo "âœ… Package is now available on PyPI"
        echo "âœ… Release notes published on GitHub"
        echo "ğŸ‰ ===================================="
