name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.11'
  
jobs:
  # ==================== CODE QUALITY ====================
  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip setuptools wheel
        pip install black flake8 mypy pandas-stubs types-requests types-PyYAML
        pip install -e .
    
    - name: Check code formatting with Black (88-char)
      run: |
        echo "üé® Checking Black formatting (88-char line limit)..."
        black --check --diff --line-length 88 varidex/ tests/
    
    - name: Lint with Flake8
      run: |
        echo "üîç Running Flake8 style checks..."
        # Stop build on syntax/undefined errors
        flake8 varidex/ tests/ --count --select=E9,F63,F7,F82 --show-source --statistics
        # Check line length and style
        flake8 varidex/ tests/ --count --max-line-length=100 --statistics --exit-zero
    
    - name: Type check with mypy (STRICT MODE)
      run: |
        echo "üî¨ Running mypy type checker (strict mode)..."
        mypy varidex/ --config-file mypy.ini
      continue-on-error: false

  # ==================== TESTING ====================
  test:
    name: Test Python ${{ matrix.python-version }} on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    needs: code-quality
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python-version: ['3.9', '3.10', '3.11', '3.12']
        exclude:
          # Skip some combinations to save CI time
          - os: windows-latest
            python-version: '3.9'
          - os: macos-latest
            python-version: '3.9'
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip setuptools wheel
        pip install -e .
        pip install -r requirements-test.txt
    
    - name: Display environment info
      run: |
        python --version
        pip list
    
    - name: Run tests with pytest
      run: |
        pytest tests/ -v --tb=short --strict-markers --maxfail=5
    
    - name: Run tests with coverage (Ubuntu + Python 3.11 only)
      if: matrix.os == 'ubuntu-latest' && matrix.python-version == '3.11'
      run: |
        pytest tests/ --cov=varidex --cov-report=xml --cov-report=term --cov-report=html
    
    - name: Upload coverage to Codecov
      if: matrix.os == 'ubuntu-latest' && matrix.python-version == '3.11'
      uses: codecov/codecov-action@v4
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false
    
    - name: Upload coverage HTML report
      if: matrix.os == 'ubuntu-latest' && matrix.python-version == '3.11'
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: htmlcov/
        retention-days: 7

  # ==================== SECURITY SCAN ====================
  security:
    name: Security Scanning
    runs-on: ubuntu-latest
    needs: code-quality
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: Install security tools
      run: |
        python -m pip install --upgrade pip
        pip install safety bandit
    
    - name: Check for known vulnerabilities with Safety
      run: |
        echo "üîí Checking dependencies for known vulnerabilities..."
        pip freeze | safety check --stdin || true
    
    - name: Security linting with Bandit
      run: |
        echo "üõ°Ô∏è Running Bandit security checks..."
        bandit -r varidex/ -ll -f json -o bandit-report.json || true
        bandit -r varidex/ -ll || true
    
    - name: Upload Bandit report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: bandit-security-report
        path: bandit-report.json
        retention-days: 30

  # ==================== PACKAGE BUILD ====================
  build:
    name: Build & Validate Package
    runs-on: ubuntu-latest
    needs: [test, security]
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install build tools
      run: |
        python -m pip install --upgrade pip build twine check-manifest
    
    - name: Check MANIFEST.in
      run: |
        echo "üìã Validating MANIFEST.in..."
        check-manifest --verbose || true
    
    - name: Build source and wheel distributions
      run: |
        echo "üì¶ Building package..."
        python -m build
        ls -lh dist/
    
    - name: Check package with twine
      run: |
        echo "‚úÖ Validating package metadata..."
        twine check dist/*
    
    - name: Test package installation
      run: |
        echo "üß™ Testing package installation..."
        pip install dist/*.whl
        python -c "import varidex; print(f'VariDex v{varidex.__version__} installed successfully')"
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: dist-packages-py${{ env.PYTHON_VERSION }}
        path: dist/
        retention-days: 14

  # ==================== DOCUMENTATION ====================
  docs:
    name: Documentation Check
    runs-on: ubuntu-latest
    needs: code-quality
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Check documentation files exist
      run: |
        echo "üìö Checking documentation completeness..."
        test -f README.md || (echo "‚ùå README.md missing" && exit 1)
        test -f CHANGELOG.md || echo "‚ö†Ô∏è CHANGELOG.md missing"
        test -f CONTRIBUTING.md || echo "‚ö†Ô∏è CONTRIBUTING.md missing"
        test -f LICENSE || (echo "‚ùå LICENSE missing" && exit 1)
        test -f docs/ACMG_28_IMPLEMENTATION.md || echo "‚ö†Ô∏è ACMG implementation docs missing"
        echo "‚úÖ Core documentation files present"
    
    - name: Check for broken links in README
      run: |
        echo "üîó Checking README for common issues..."
        # Check if README has basic sections
        grep -q "## Features" README.md || echo "‚ö†Ô∏è Features section missing"
        grep -q "## Installation" README.md || echo "‚ö†Ô∏è Installation section missing"
        grep -q "## Usage" README.md || echo "‚ö†Ô∏è Usage section missing"
        echo "‚úÖ README structure validated"

  # ==================== FINAL STATUS ====================
  ci-success:
    name: CI Pipeline Success
    runs-on: ubuntu-latest
    needs: [code-quality, test, security, build, docs]
    if: success()
    
    steps:
    - name: Success notification
      run: |
        echo "‚úÖ =================================="
        echo "‚úÖ ALL CI/CD CHECKS PASSED!"
        echo "‚úÖ =================================="
        echo "‚úÖ Code Quality: PASSED"
        echo "‚úÖ Tests: PASSED"
        echo "‚úÖ Security: PASSED"
        echo "‚úÖ Build: PASSED"
        echo "‚úÖ Documentation: PASSED"
        echo "‚úÖ =================================="
        echo "üöÄ Ready for deployment!"
