#!/usr/bin/env python3
"""varidex/core/classifier/engine_v7.py - ACMG Classifier with gnomAD Integration

Production ACMG 2015 variant classifier with population frequency analysis.

Enabled Evidence (10 codes):
  Pathogenic:
    - PVS1: LOF in LOF-intolerant genes
    - PM2: Absent/rare in population databases (gnomAD)
    - PM4: Protein length changes
    - PP2: Missense in missense-rare genes

  Benign:
    - BA1: Common polymorphism >5% (gnomAD)
    - BS1: Allele frequency too high >1% (gnomAD)
    - BP1: Missense in LOF genes
    - BP3: In-frame indel in repetitive region

Disabled Evidence (18 codes):
  PS1-4, PM1, PM3, PM5-6, PP1, PP3-5, BS2-4, BP2, BP4-7

Reference: Richards et al. 2015, PMID 25741868
"""

from typing import Tuple, Optional, Dict, Any
import logging
import time

from varidex.core.models import ACMGEvidenceSet, VariantData
from varidex.core.classifier.engine import ACMGClassifier
from varidex.core.classifier.config import ACMGConfig
from varidex.core.services.population_frequency import (
    PopulationFrequencyService,
    InheritanceMode,
    FrequencyThresholds,
from varidex.integrations.gnomad_client import GnomadClient

logger = logging.getLogger(__name__)


class ACMGClassifierV7(ACMGClassifier):
    """Enhanced ACMG classifier with gnomAD population frequency integration.

    Extends ACMGClassifier v6.3 with:
    - PM2: Absent/rare in gnomAD
    - BA1: Common polymorphism in gnomAD
    - BS1: Frequency too high in gnomAD

    Maintains backward compatibility and graceful degradation.
    """

    VERSION = "7.0.1"

    def __init__(
        self,
        config: Optional[ACMGConfig] = None,
        enable_gnomad: bool = True,
        gnomad_client: Optional[GnomadClient] = None,
        frequency_thresholds: Optional[FrequencyThresholds] = None,
    ) -> None:
        """Initialize enhanced classifier with gnomAD integration."""
        # Initialize base classifier
        super().__init__(config)

        # Initialize frequency service
        self.enable_gnomad: bool = enable_gnomad
        self.frequency_service: Optional[PopulationFrequencyService] = None

        if enable_gnomad:
            try:
                self.frequency_service = PopulationFrequencyService(
                    gnomad_client=gnomad_client,
                    thresholds=frequency_thresholds,
                    enable_gnomad=True,
                logger.info(f"ACMGClassifierV7 {self.VERSION} initialized with gnomAD")
            except Exception as e:
                logger.error(f"Failed to initialize gnomAD service: {e}")
                logger.warning("Continuing without gnomAD integration")
                self.enable_gnomad = False
                self.frequency_service = None
        else:
            logger.info(f"ACMGClassifierV7 {self.VERSION} initialized without gnomAD")

    def _extract_variant_coordinates(
        self, variant: VariantData
    ) -> Optional[Dict[str, Any]]:
        """Extract normalized coordinates from a variant for gnomAD queries.

        Handles multiple possible attribute names for compatibility.

        Returns:
            dict with keys: chromosome, position, ref, alt, optional gene
            or None if required info missing
        """
        try:
            coords: Dict[str, Any] = {}

            # Chromosome
            chrom = getattr(variant, "chromosome", None) or getattr(
                variant, "chrom", None
            if not chrom:
                return None
            coords["chromosome"] = str(chrom).replace("chr", "")

            # Position
            pos = getattr(variant, "position", None) or getattr(variant, "pos", None)
            if not pos:
                return None
            coords["position"] = int(pos)

            # Reference allele
            ref = getattr(variant, "ref_allele", None) or getattr(variant, "ref", None)
            if not ref:
                return None
            coords["ref"] = str(ref)

            # Alternate allele
            alt = getattr(variant, "alt_allele", None) or getattr(variant, "alt", None)
            if not alt:
                return None
            coords["alt"] = str(alt)

            # Optional gene
            gene = getattr(variant, "gene", None)
            if gene:
                coords["gene"] = str(gene)

            return coords

        except Exception as e:
            logger.warning(f"Failed to extract variant coordinates: {e}")
            return None

    def _infer_inheritance_mode(self, variant: VariantData) -> InheritanceMode:
        """Infer inheritance mode from variant data."""
        try:
            if hasattr(variant, "inheritance_mode") and variant.inheritance_mode:
                mode_str = str(variant.inheritance_mode).lower()
                if "dominant" in mode_str or "ad" in mode_str:
                    return InheritanceMode.DOMINANT
                elif "recessive" in mode_str or "ar" in mode_str:
                    return InheritanceMode.RECESSIVE
                elif "x-linked" in mode_str or "xl" in mode_str:
                    return InheritanceMode.X_LINKED

            if hasattr(variant, "chromosome"):
                chrom = str(variant.chromosome).replace("chr", "").upper()
                if chrom == "X":
                    return InheritanceMode.X_LINKED

            return InheritanceMode.UNKNOWN

        except Exception as e:
            logger.debug(f"Failed to infer inheritance mode: {e}")
            return InheritanceMode.UNKNOWN

    def assign_evidence(self, variant: VariantData) -> ACMGEvidenceSet:
        """Assign ACMG evidence codes including gnomAD-based codes."""
        evidence = super().assign_evidence(variant)

        if self.enable_gnomad and self.frequency_service:
            try:
                coords = self._extract_variant_coordinates(variant)

                if coords is None:
                    logger.debug(
                        "No coordinates for gnomAD query, skipping frequency analysis"
                    evidence.conflicts.add("Missing coordinates for gnomAD")
                    return evidence

                inheritance = self._infer_inheritance_mode(variant)

                freq_evidence = self.frequency_service.analyze_frequency(
                    chromosome=coords["chromosome"],
                    position=coords["position"],
                    ref=coords["ref"],
                    alt=coords["alt"],
                    inheritance=inheritance,
                    gene=coords.get("gene"),

                if freq_evidence.pm2:
                    evidence.pm.add("PM2")
                    logger.info(f"PM2: {freq_evidence.reasoning}")

                if freq_evidence.ba1:
                    evidence.ba.add("BA1")
                    logger.info(f"BA1: {freq_evidence.reasoning}")

                if freq_evidence.bs1:
                    evidence.bs.add("BS1")
                    logger.info(f"BS1: {freq_evidence.reasoning}")

                if hasattr(evidence, "metadata"):
                    evidence.metadata["gnomad_af"] = freq_evidence.max_af
                    evidence.metadata["gnomad_population"] = (
                        freq_evidence.max_af_population

                logger.debug(f"Frequency analysis: {freq_evidence.summary()}")

            except Exception as e:
                logger.error(f"gnomAD frequency analysis failed: {e}")
                evidence.conflicts.add(f"gnomAD error: {str(e)}")

        for attr in ["pvs", "ps", "pm", "pp", "ba", "bs", "bp"]:
            setattr(evidence, attr, list(getattr(evidence, attr)))

        return evidence

    def classify_variant(
        self, variant: VariantData
    ) -> Tuple[str, str, ACMGEvidenceSet, float]:
        """Complete classification pipeline with gnomAD integration."""
        start_time = time.time()

        try:
            evidence = self.assign_evidence(variant)
            classification, confidence = self.combine_evidence(evidence)
            duration = time.time() - start_time

            if self.metrics:
                self.metrics.record_success(duration, classification, evidence)

            logger.info(
                f"Classified {variant} â†’ {classification} ({confidence}) "
                f"in {duration:.3f}s [gnomAD: {self.enable_gnomad}]"

            return classification, confidence, evidence, duration

        except Exception as e:
            duration = time.time() - start_time
            if self.metrics:
                self.metrics.record_failure()

            logger.error(f"Classification pipeline failed: {e}", exc_info=True)
            return (
                "Uncertain Significance",
                f"Error: {str(e)}",
                ACMGEvidenceSet(),
                duration,

    def health_check(self) -> Dict[str, Any]:
        """Health check with gnomAD service status."""
        health = super().health_check()
        health["gnomad"] = {
            "enabled": self.enable_gnomad,
            "service_initialized": self.frequency_service is not None,
        }
        if self.frequency_service:
            try:
                health["gnomad"]["statistics"] = self.frequency_service.get_statistics()
            except Exception as e:
                health["gnomad"]["error"] = str(e)
        health["version"] = self.VERSION
        return health

    def get_enabled_codes(self) -> Dict[str, list]:
        """Get list of enabled evidence codes."""
        codes: Dict[str, list] = {
            "pathogenic": ["PVS1", "PM4", "PP2"],
            "benign": ["BP1", "BP3"],
        }
        if self.enable_gnomad:
            codes["pathogenic"].append("PM2")
            codes["benign"].extend(["BA1", "BS1"])
        return codes


if __name__ == "__main__":
    print("=" * 80)
    print(f"ACMG Classifier V7 {ACMGClassifierV7.VERSION} - gnomAD Integration")
    print("=" * 80)
    print("\nEnabled Evidence Codes:")
    classifier = ACMGClassifierV7(enable_gnomad=False)
    codes = classifier.get_enabled_codes()
    print(f"  Pathogenic: {', '.join(codes['pathogenic'])}")
    print(f"  Benign: {', '.join(codes['benign'])}")
    print("\nWith gnomAD: +PM2, +BA1, +BS1 (10 total codes)")
    print("Without gnomAD: 7 codes (falls back to v6 behavior)")
    print("=" * 80)
else:
    logger.info(f"ACMGClassifierV7 {ACMGClassifierV7.VERSION} loaded")
    logger.info("  Enhanced with gnomAD population frequency (PM2, BA1, BS1)")
    logger.info(
        "  Backward compatible with v6, graceful degradation if gnomAD unavailable"
