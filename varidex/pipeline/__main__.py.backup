#!/usr/bin/env python3
"""
VariDex v7.0.2 COMPLETE Pipeline + 13-Code ACMG

Full pipeline with ALL existing features preserved
"""

from argparse import ArgumentParser, Namespace
from pathlib import Path

import pandas as pd

from varidex import __version__
from varidex.downloader import setup_genomic_data
from varidex.io.loaders.clinvar import load_clinvar_file
from varidex.io.loaders.user import load_user_file
from varidex.io.matching_improved import match_variants_hybrid
from varidex.pipeline.acmg_classifier_stage import apply_full_acmg_classification


def enhance_with_phase1(results_df: pd.DataFrame) -> pd.DataFrame:
    """Add Phase 1 ACMG codes (PP5, BP6, BP7, BS2)."""
    for code in ['PP5', 'BP6', 'BP7', 'BS2']:
        if code not in results_df.columns:
            results_df[code] = False
    
    counts = {'BP7': 0, 'PP5': 0, 'BP6': 0, 'BS2': 0}
    
    for idx, row in results_df.iterrows():
        cons = str(row.get('molecular_consequence', '')).lower()
        rev = str(row.get('review_status', '')).lower()
        sig = str(row.get('clinical_sig', '')).lower()
        af = row.get('gnomad_af')
        
        if ('synonymous' in cons or 'silent' in cons) and 'splice' not in cons:
            results_df.at[idx, 'BP7'] = True
            counts['BP7'] += 1
        
        if 'expert_panel' in rev or 'practice_guideline' in rev:
            if 'pathogenic' in sig and 'benign' not in sig:
                results_df.at[idx, 'PP5'] = True
                counts['PP5'] += 1
            elif 'benign' in sig:
                results_df.at[idx, 'BP6'] = True
                counts['BP6'] += 1
        
        if pd.notna(af) and af > 0.01 and 'pathogenic' in sig and 'benign' not in sig:
            results_df.at[idx, 'BS2'] = True
            counts['BS2'] += 1
    
    print(f"\nâ­ Phase 1: BP7={counts['BP7']:,}, PP5={counts['PP5']:,}, "
          f"BP6={counts['BP6']:,}, BS2={counts['BS2']:,}")
    return results_df


def main() -> None:
    parser = ArgumentParser(
        description=f"VariDex v{__version__} - Full Pipeline with 13-Code ACMG"
    )
    parser.add_argument(
        "--clinvar",
        default="clinvar/clinvar_GRCh37.vcf.gz",
        help="ClinVar VCF file",
    )
    parser.add_argument(
        "--user-genome", required=True, help="Your genome file (VCF or 23andMe)"
    )
    parser.add_argument("--output", default="results_michal", help="Output directory")

    args: Namespace = parser.parse_args()

    print(f"{'='*70}")
    print(f"ğŸ§¬ VariDex v{__version__} - Full 13-Code ACMG Pipeline")
    print(f"{'='*70}\n")

    # Step 1: Verify ClinVar exists
    print("ğŸ“¥ Step 1: Setup genomic data...")
    clinvar_path = Path(args.clinvar)
    
    if not clinvar_path.exists():
        print(f"âš ï¸  ClinVar not found at {clinvar_path}")
        print("   Calling setup_genomic_data() to download...")
        setup_genomic_data()
        clinvar_path = Path("clinvar/clinvar_GRCh37.vcf.gz")
    
    print(f"âœ… ClinVar: {clinvar_path}\n")

    # Step 2: Load ClinVar
    print("ğŸ“– Step 2: Loading ClinVar...")
    clinvar_df = load_clinvar_file(str(clinvar_path))
    print(f"âœ… Loaded {len(clinvar_df):,} ClinVar variants\n")

    # Step 3: Load user genome
    print("ğŸ“– Step 3: Loading your genome...")
    user_df = load_user_file(args.user_genome)
    print(f"âœ… Loaded {len(user_df):,} variants from your genome\n")

    # Step 4: Match variants (hybrid algorithm)
    print("ğŸ”— Step 4: Matching variants (hybrid: rsID + coordinates)...")
    matched_df, rsid_matches, coord_matches = match_variants_hybrid(
        clinvar_df, user_df
    )
    total_matches = len(matched_df)
    print(f"âœ… Matched {total_matches:,} variants:")
    print(f"   â€¢ rsID matches: {rsid_matches:,}")
    print(f"   â€¢ Coordinate matches: {coord_matches:,}\n")

    # Step 5: ACMG classification (8 codes)
    print("ğŸ”¬ Step 5: Applying ACMG classification (8 codes)...")
    classified_df = apply_full_acmg_classification(matched_df)
    print("âœ… Complete\n")

    # Step 6: Phase 1 enhancement (+5 codes = 13 total)
    print("â­ Step 6: Applying Phase 1 enhancements (+5 codes)...")
    results_df = enhance_with_phase1(classified_df)
    print("âœ… Complete\n")

    # Step 7: Save results
    print("ğŸ’¾ Step 7: Saving results...")
    output_path = Path(args.output)
    output_path.mkdir(parents=True, exist_ok=True)

    results_file = output_path / "results_13codes.csv"
    results_df.to_csv(results_file, index=False)

    # Priority files
    pathogenic = results_df[
        results_df['clinical_sig'].str.contains('athogenic', na=False, case=False)
    ]
    pvs1 = pathogenic[pathogenic['PVS1']]
    pm2 = pathogenic[pathogenic['PM2']]

    pvs1.to_csv(output_path / "PRIORITY_PVS1.csv", index=False)
    pm2.to_csv(output_path / "PRIORITY_PM2.csv", index=False)
    pathogenic.to_csv(output_path / "ALL_PATHOGENIC.csv", index=False)

    print(f"âœ… Saved to {output_path.absolute()}/\n")

    # Statistics - only use codes that actually exist
    implemented_codes = [
        'PVS1', 'PM2', 'PM4', 'PP2', 'PP5',
        'BA1', 'BS1', 'BS2', 'BP1', 'BP3', 'BP6', 'BP7'
    ]
    existing_codes = [c for c in implemented_codes if c in results_df.columns]
    
    has_evidence = results_df[existing_codes].any(axis=1).sum()
    coverage = has_evidence / len(results_df) * 100 if len(results_df) > 0 else 0

    print(f"{'='*70}")
    print("âœ… PIPELINE COMPLETE - 13 ACMG Codes")
    print(f"{'='*70}")
    print(f"\nğŸ“Š Results:")
    print(f"  Total variants: {len(results_df):,}")
    print(f"  With ACMG evidence: {has_evidence:,} ({coverage:.1f}%)")
    print(f"  Pathogenic: {len(pathogenic):,}")
    print(f"\nğŸ¯ Priority:")
    print(f"  PVS1 (loss of function): {len(pvs1):,}")
    print(f"  PM2 (rare pathogenic): {len(pm2):,}")
    print(f"\nğŸ“ Output files:")
    print(f"  â€¢ results_13codes.csv")
    print(f"  â€¢ PRIORITY_PVS1.csv")
    print(f"  â€¢ PRIORITY_PM2.csv")
    print(f"  â€¢ ALL_PATHOGENIC.csv")
    print(f"\nâš ï¸  Note: Only {total_matches:,} variants matched.")
    print(f"   For better results, check user file format.")
    print(f"{'='*70}\n")


if __name__ == "__main__":
    main()
